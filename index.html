<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facebook 社團專用 PDF 閱讀</title>
  <script>
    var urlParams = new URLSearchParams(window.location.search);
    var fbclid = urlParams.get('fbclid');  // 取得 Facebook 參數
    var referrer = document.referrer || "";  // 取得上一個訪問的網頁
    var userAgent = navigator.userAgent || navigator.vendor || window.opera; // 取得裝置資訊

    console.log("Referrer:", referrer);
    console.log("User Agent:", userAgent);
    console.log("fbclid:", fbclid);

    // **Step 1：強制阻擋 Messenger 及非 Facebook 來源**
    if (
      userAgent.includes("FBAN") || userAgent.includes("FBAV") || userAgent.includes("Messenger") ||
      referrer.includes("m.facebook.com") || referrer.includes("l.facebook.com")
    ) {
      console.log("阻擋 Messenger 或 Facebook 以外來源，跳轉回 Facebook 社團");
      window.location.href = "https://www.facebook.com/groups/667112409185609";  // Facebook 社團網址
    }

    // **Step 2：如果來自 Facebook 社團或帶有 fbclid，則存入 sessionStorage**
    if (referrer.includes("facebook.com/groups/667112409185609") || fbclid) {
      sessionStorage.setItem("fromFacebookGroup", "true");  // 記錄來自 Facebook 社團
    }

    // **Step 3：如果 `sessionStorage` 沒有 Facebook 來源，則跳轉回社團**
    if (!sessionStorage.getItem("fromFacebookGroup")) {
      console.log("未通過 Facebook 社團驗證，跳轉回 Facebook 社團");
      window.location.href = "https://www.facebook.com/groups/667112409185609";  // Facebook 社團網址
    }

    // **Step 4：禁止右鍵、禁止開發者工具**
    document.addEventListener('contextmenu', event => event.preventDefault());

    document.addEventListener('keydown', function(event) {
      if ((event.ctrlKey && event.key === 's') || (event.ctrlKey && event.key === 'p')) {
        event.preventDefault();
        alert("禁止下載或列印此 PDF");
      }
      if (event.key === "F12" || (event.ctrlKey && event.shiftKey && event.key === "I")) {
        event.preventDefault();
        alert("禁止開發者工具！");
      }
    });

  </script>
</head>
<body>
  <h2>Facebook 社團專屬 PDF 閱讀</h2>
  <div id="pdfContainer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    var pdfUrl = "Sufficiency%20Proof%20at%20the%20Critical%20Point.pdf";

    function renderPDF(url) {
      var container = document.getElementById('pdfContainer');

      pdfjsLib.getDocument(url).promise.then(function(pdf) {
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          pdf.getPage(pageNum).then(function(page) {
            var canvas = document.createElement('canvas');
            container.appendChild(canvas);
            var ctx = canvas.getContext('2d', { willReadFrequently: true });

            var viewport = page.getViewport({ scale: 3.0 }); // 提高解析度
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            var renderContext = {
              canvasContext: ctx,
              viewport: viewport
            };
            page.render(renderContext);
          });
        }
      });
    }

    renderPDF(pdfUrl);
  </script>
</body>
</html>
